---
layout: default
---

{% comment %}Find first CSV resource — used by XLSX download and pivot table{% endcomment %}
{% assign csv_url = "" %}
{% for resource in page.resources %}
  {% assign _fmt = resource.format | downcase %}
  {% if _fmt == "csv" or resource.url contains ".csv" %}
    {% assign csv_url = resource.url %}
  {% endif %}
{% endfor %}

<!-- PivotTable.js styles (dataset pages only) -->
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/themes/base/jquery-ui.min.css">
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.css">
<style>
  .pivot-wrapper { overflow-x: auto; }
  .pvtUi, .pvtUi select, .pvtTable { font-family: 'Lato', Arial, sans-serif; font-size: .85rem !important; }
  .pvtTable { border-collapse: collapse; }
  .pvtAxisContainer, .pvtVals { background: var(--gi-gray-50); border-color: var(--gi-gray-200) !important; }
  .pvtFilterBox { z-index: 1050; }
</style>

<div class="row">
  <!-- Main content -->
  <div class="col-lg-8">
    <h1 class="mb-1">{{ page.title }}</h1>
    {% if page.description %}
    <p class="lead text-muted mb-4">{{ page.description }}</p>
    {% endif %}

    <!-- Resources -->
    {% if page.resources %}
    <h2 class="h5 mb-3">Resources</h2>
    <div class="list-group mb-4">
      {% for resource in page.resources %}
      <div class="list-group-item d-flex align-items-center gap-3">
        <i class="bi bi-file-earmark-arrow-down fs-4 text-primary flex-shrink-0"></i>
        <div class="flex-grow-1">
          <div class="fw-semibold">{{ resource.name | default: resource.url }}</div>
          {% if resource.format %}
          <small class="text-muted">Format: {{ resource.format }}</small>
          {% endif %}
          {% if resource.description %}
          <small class="text-muted d-block">{{ resource.description }}</small>
          {% endif %}
        </div>
        <div class="d-flex gap-2 flex-shrink-0">
          <a href="{{ resource.url }}" class="btn btn-sm btn-outline-primary"
             target="_blank" rel="noopener noreferrer">
            Download CSV
          </a>
          {% assign _fmt2 = resource.format | downcase %}
          {% if _fmt2 == "csv" or resource.url contains ".csv" %}
          <button class="btn btn-sm btn-outline-success"
                  data-csv-url="{{ resource.url }}"
                  data-filename="{{ page.slug }}.xlsx"
                  onclick="downloadXlsx(this)">
            Download XLSX
          </button>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- Data preview -->
    {% if page.preview %}
      {% assign _preview_path = "previews/" | append: page.preview | append: ".html" %}
      <h2 class="h5 mb-3">Data Preview</h2>
      <div class="preview-table-wrapper mb-4">
        {% include {{ _preview_path }} %}
      </div>
    {% endif %}

    <!-- Page body content (if any) -->
    {% if content != "" %}
    <div class="mt-4">{{ content }}</div>
    {% endif %}
  </div>

  <!-- Sidebar -->
  <div class="col-lg-4">
    <div class="card">
      <div class="card-header fw-semibold">Dataset Information</div>
      <div class="card-body p-0">
        <table class="table table-sm meta-table mb-0">
          <tbody>
            {% for field in site.data.schemas.default.fields %}
              {% assign field_value = page[field.key] %}
              {% if field_value %}
              <tr>
                <th class="ps-3 py-2 text-muted fw-normal">{{ field.label }}</th>
                <td class="pe-3 py-2">
                  {% if field.key == "maintainer_email" %}
                    <a href="mailto:{{ field_value }}">{{ field_value }}</a>
                  {% elsif field_value contains "http" %}
                    <a href="{{ field_value }}" target="_blank" rel="noopener noreferrer">{{ field_value }}</a>
                  {% elsif field_value.first %}
                    {{ field_value | join: ", " }}
                  {% else %}
                    {{ field_value }}
                  {% endif %}
                </td>
              </tr>
              {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Pivot table explorer (full width, below main row) -->
{% if csv_url != "" %}
<div class="mt-4 mb-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="h5 mb-0">Explore Data</h2>
    <button id="pivotToggle" class="btn btn-sm btn-outline-primary" onclick="togglePivot()">
      Open Pivot Table
    </button>
  </div>
  <div id="pivotSection" style="display:none">
    <p class="text-muted small mb-3">
      Drag field names into the row and column areas to pivot and summarise the data.
    </p>
    <div id="pivotLoading" class="text-muted small py-2">
      <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
      Loading data&hellip;
    </div>
    <div id="pivotOutput" class="pivot-wrapper"></div>
  </div>
</div>
{% endif %}

<!-- SheetJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
  integrity="sha512-r22gChDnGvBylk90+2e/ycr3RVrDi8DIOkIGNhJlKfuyQM4tIRAI062MaV8sfjQKYVGjOBaZBOA87z+IhZE9DA=="
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- jQuery + jQuery UI (PivotTable.js dependencies) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- PapaParse (CSV parser) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- PivotTable.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.js"
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
/* ── XLSX download ───────────────────────────────────────────────────────── */
function downloadXlsx(btn) {
  var url = btn.getAttribute('data-csv-url');
  var filename = btn.getAttribute('data-filename');
  var original = btn.textContent;
  btn.disabled = true;
  btn.textContent = 'Preparing\u2026';
  fetch(url)
    .then(function(r) {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.text();
    })
    .then(function(csv) {
      var wb = XLSX.read(csv, { type: 'string' });
      XLSX.writeFile(wb, filename);
    })
    .catch(function() {
      alert('Could not download the file. Check that the resource URL is publicly accessible.');
    })
    .finally(function() {
      btn.disabled = false;
      btn.textContent = original;
    });
}

/* ── Pivot table ─────────────────────────────────────────────────────────── */
{% if csv_url != "" %}
var _pivotCsvUrl = {{ csv_url | jsonify }};
var _pivotReady  = false;

function togglePivot() {
  var section = document.getElementById('pivotSection');
  var btn     = document.getElementById('pivotToggle');
  var opening = section.style.display === 'none';

  section.style.display = opening ? 'block' : 'none';
  btn.textContent = opening ? 'Close Pivot Table' : 'Open Pivot Table';

  if (opening && !_pivotReady) { _loadPivot(); }
}

function _loadPivot() {
  Papa.parse(_pivotCsvUrl, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      document.getElementById('pivotLoading').style.display = 'none';
      $('#pivotOutput').pivotUI(results.data, {
        rendererName:    'Table',
        aggregatorName:  'Count',
        unusedAttrsVertical: false
      });
      _pivotReady = true;
    },
    error: function() {
      document.getElementById('pivotLoading').outerHTML =
        '<div class="alert alert-warning">Could not load data for the pivot table.</div>';
    }
  });
}
{% endif %}
</script>
